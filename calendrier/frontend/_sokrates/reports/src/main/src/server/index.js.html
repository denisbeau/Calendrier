<html>
<head>
    <title>src/server/index.js</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">src/server/index.js (<b>110</b> lines of code) (<a href="index.js">raw</a>):</h3>
<div id="editor">import express from &quot;express&quot;;
import cors from &quot;cors&quot;;
import dotenv from &quot;dotenv&quot;;
import nodemailer from &quot;nodemailer&quot;;

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 3001;

// Create a nodemailer transporter using SMTP settings from env
function createTransporter() {
  const host = process.env.SMTP_HOST;
  const port = process.env.SMTP_PORT
    ? Number(process.env.SMTP_PORT)
    : undefined;
  const user = process.env.SMTP_USER;
  const pass = process.env.SMTP_PASS;

  if (!host) return null;

  return nodemailer.createTransport({
    host,
    port,
    secure: port === 465, // true for 465, false for other ports
    auth: user &amp;&amp; pass ? { user, pass } : undefined,
  });
}

const transporter = createTransporter();

app.get(&quot;/api/health&quot;, (req, res) =&gt; res.json({ ok: true }));

// POST /api/invite
// body: { groupId, email }
app.post(&quot;/api/invite&quot;, async (req, res) =&gt; {
  const { groupId, email } = req.body || {};
  if (!groupId || !email) {
    return res.status(400).json({ error: &quot;groupId and email are required&quot; });
  }

  const frontend =
    process.env.FRONTEND_URL ||
    process.env.VITE_FRONTEND_URL ||
    &quot;http://localhost:5173&quot;;
  const acceptUrl = `${frontend.replace(
    /\/$/,
    &quot;&quot;
  )}/accept-invite?group=${encodeURIComponent(
    groupId
  )}&amp;email=${encodeURIComponent(email)}`;

  // Compose email
  const from =
    process.env.FROM_EMAIL ||
    `no-reply@${process.env.SMTP_HOST || &quot;localhost&quot;}`;
  const subject = `Invitation &agrave; rejoindre le groupe (${groupId})`;
  const text = `Vous &ecirc;tes invit&eacute;(e) &agrave; rejoindre le groupe. Acceptez l'invitation : ${acceptUrl}`;
  const html = `&lt;p&gt;Vous &ecirc;tes invit&eacute;(e) &agrave; rejoindre le groupe.&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;${acceptUrl}&quot;&gt;Accepter l'invitation&lt;/a&gt;&lt;/p&gt;`;

  // If transporter is not configured, return created but with warning
  if (!transporter) {
    console.warn(
      &quot;SMTP transporter not configured. Set SMTP_HOST and related env vars to actually send emails.&quot;
    );
    return res
      .status(201)
      .json({ ok: true, warn: &quot;smtp-not-configured&quot;, acceptUrl });
  }

  try {
    await transporter.sendMail({ from, to: email, subject, text, html });
    return res.status(201).json({ ok: true });
  } catch (err) {
    console.error(&quot;Failed to send invite email:&quot;, err);
    return res.status(500).json({ error: &quot;failed-to-send&quot; });
  }
});

// compatibility with frontend `inviteByEmail` which calls /api/send-invite
app.post(&quot;/api/send-invite&quot;, async (req, res) =&gt; {
  const { email, groupId, token, groupName, inviterEmail, acceptUrlBase } =
    req.body || {};

  if (!email || !groupId || !token) {
    return res
      .status(400)
      .json({ error: &quot;email, groupId and token are required&quot; });
  }

  const frontend =
    acceptUrlBase ||
    process.env.FRONTEND_URL ||
    process.env.VITE_FRONTEND_URL ||
    &quot;http://localhost:5173&quot;;

  const acceptUrl = `${frontend.replace(
    /\/$/,
    &quot;&quot;
  )}/accept-invite?token=${encodeURIComponent(token)}`;

  const from =
    process.env.FROM_EMAIL ||
    `no-reply@${process.env.SMTP_HOST || &quot;localhost&quot;}`;
  const subject = `Invitation &agrave; rejoindre ${groupName || &quot;un groupe&quot;}`;
  const text = `Vous &ecirc;tes invit&eacute;(e) &agrave; rejoindre ${
    groupName || &quot;un groupe&quot;
  }. Acceptez : ${acceptUrl}`;
  const html = `&lt;p&gt;${
    inviterEmail ? `${inviterEmail} ` : &quot;&quot;
  }vous invite &agrave; rejoindre &lt;strong&gt;$
  {groupName || &quot;le groupe&quot;}&lt;/strong&gt;.&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;${acceptUrl}&quot;&gt;Accepter l'invitation&lt;/a&gt;&lt;/p&gt;`;

  if (!transporter) {
    console.warn(
      &quot;SMTP transporter not configured. Set SMTP_HOST and related env vars to actually send emails.&quot;
    );
    return res
      .status(201)
      .json({ ok: true, warn: &quot;smtp-not-configured&quot;, acceptUrl });
  }

  try {
    await transporter.sendMail({ from, to: email, subject, text, html });
    return res.status(201).json({ ok: true });
  } catch (err) {
    console.error(&quot;Failed to send invite email:&quot;, err);
    return res.status(500).json({ error: &quot;failed-to-send&quot; });
  }
});

app.listen(PORT, () =&gt; {
  console.log(`Invite server listening on http://localhost:${PORT}`);
});
</div>
<script src="https://www.zeljkoobrenovic.com/tools/common/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/javascript");
    editor.setTheme("ace/theme/xcode");
    editor.setReadOnly(true);
    editor.setOption("wrap", true);
    editor.setPrintMarginColumn(120);
</script>
</body>
