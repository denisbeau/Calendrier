<html>
<head>
    <title>Calendar.jsx</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">Calendar.jsx (<b>513</b> lines of code) (<a href="Calendar.jsx">raw</a>):</h3>
<div id="editor">// src/Calendar.jsx
import { supabase } from &quot;./supabaseClient&quot;;
import { createEvent } from &quot;./services/api&quot;;
import React, { useState, useMemo } from &quot;react&quot;;
import { Calendar, dateFnsLocalizer } from &quot;react-big-calendar&quot;;
import format from &quot;date-fns/format&quot;;
import parse from &quot;date-fns/parse&quot;;
import startOfWeek from &quot;date-fns/startOfWeek&quot;;
import getDay from &quot;date-fns/getDay&quot;;
import enUS from &quot;date-fns/locale/en-US&quot;;
import &quot;react-big-calendar/lib/css/react-big-calendar.css&quot;;

const locales = { &quot;en-US&quot;: enUS };
const localizer = dateFnsLocalizer({
  format,
  parse,
  startOfWeek,
  getDay,
  locales,
});

export default function MyBigCalendar() {
  const getCurrentDateTime = () =&gt; {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, &quot;0&quot;);
    const day = String(now.getDate()).padStart(2, &quot;0&quot;);
    const hours = String(now.getHours()).padStart(2, &quot;0&quot;);
    const minutes = String(now.getMinutes()).padStart(2, &quot;0&quot;);
    return `${year}-${month}-${day}T${hours}:${minutes}`;
  };

  const getOneHourFromNow = () =&gt; {
    const now = new Date();
    now.setHours(now.getHours() + 1);
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, &quot;0&quot;);
    const day = String(now.getDate()).padStart(2, &quot;0&quot;);
    const hours = String(now.getHours()).padStart(2, &quot;0&quot;);
    const minutes = String(now.getMinutes()).padStart(2, &quot;0&quot;);
    return `${year}-${month}-${day}T${hours}:${minutes}`;
  };

  const formatDateTimeLocal = (date) =&gt; {
    const d = new Date(date);
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, &quot;0&quot;);
    const day = String(d.getDate()).padStart(2, &quot;0&quot;);
    const hours = String(d.getHours()).padStart(2, &quot;0&quot;);
    const minutes = String(d.getMinutes()).padStart(2, &quot;0&quot;);
    return `${year}-${month}-${day}T${hours}:${minutes}`;
  };

  const [events, setEvents] = useState([]);
  const [newEvent, setNewEvent] = useState({
    title: &quot;&quot;,
    start: getCurrentDateTime(),
    end: getOneHourFromNow(),
    allDay: false,
  });
  const [editingEvent, setEditingEvent] = useState(null);
  const [errors, setErrors] = useState({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [currentView, setCurrentView] = useState(&quot;week&quot;);

  // Save-all states
  const [isSavingAll, setIsSavingAll] = useState(false);
  const [saveAllMessage, setSaveAllMessage] = useState(null);

  // Basic id generator for demo purposes
  const nextId = useMemo(() =&gt; {
    return () =&gt; Math.max(0, ...events.map((e) =&gt; e.id || 0)) + 1;
  }, [events]);

  function validateEvent(event) {
    const newErrors = {};

    if (!event.title || !event.title.trim()) {
      newErrors.title = &quot;Event title is required&quot;;
    }

    if (!event.start) {
      newErrors.start = &quot;Start time is required&quot;;
    }

    if (!event.end) {
      newErrors.end = &quot;End time is required&quot;;
    }

    if (event.start &amp;&amp; event.end) {
      const startDate = new Date(event.start);
      const endDate = new Date(event.end);

      if (isNaN(startDate.getTime())) {
        newErrors.start = &quot;Invalid start date&quot;;
      }

      if (isNaN(endDate.getTime())) {
        newErrors.end = &quot;Invalid end date&quot;;
      }

      if (startDate &gt;= endDate) {
        newErrors.end = &quot;End time must be after start time&quot;;
      }
    }

    return newErrors;
  }

  async function handleAddEvent(e) {
    e.preventDefault();

    if (isSubmitting) return; // Prevent double submission

    setIsSubmitting(true);
    setErrors({});

    try {
      const validationErrors = validateEvent(newEvent);

      if (Object.keys(validationErrors).length &gt; 0) {
        setErrors(validationErrors);
        return;
      }

      const startDate = new Date(newEvent.start);
      const endDate = new Date(newEvent.end);

      const newEventObj = {
        id: nextId(),
        title: newEvent.title.trim(),
        start: startDate,
        end: endDate,
        allDay: newEvent.allDay,
      };

      setEvents((prev) =&gt; [...prev, newEventObj]);
      setNewEvent({
        title: &quot;&quot;,
        start: getCurrentDateTime(),
        end: getOneHourFromNow(),
        allDay: false,
      });
    } catch (error) {
      console.error(&quot;Error adding event:&quot;, error);
      setErrors({ general: &quot;Failed to add event. Please try again.&quot; });
    } finally {
      setIsSubmitting(false);
    }
  }

  async function handleUpdateEvent(e) {
    e.preventDefault();

    if (isSubmitting || !editingEvent) return;

    setIsSubmitting(true);
    setErrors({});

    try {
      const validationErrors = validateEvent(editingEvent);

      if (Object.keys(validationErrors).length &gt; 0) {
        setErrors(validationErrors);
        return;
      }

      const startDate = new Date(editingEvent.start);
      const endDate = new Date(editingEvent.end);

      const updatedEvent = {
        ...editingEvent,
        title: editingEvent.title.trim(),
        start: startDate,
        end: endDate,
      };

      setEvents((prev) =&gt;
        prev.map((event) =&gt;
          event.id === editingEvent.id ? updatedEvent : event
        )
      );

      setEditingEvent(null);
    } catch (error) {
      console.error(&quot;Error updating event:&quot;, error);
      setErrors({ general: &quot;Failed to update event. Please try again.&quot; });
    } finally {
      setIsSubmitting(false);
    }
  }

  function handleSelectEvent(event) {
    // Set the event for editing
    setEditingEvent({
      ...event,
      start: formatDateTimeLocal(event.start),
      end: formatDateTimeLocal(event.end),
    });
  }

  async function handleDeleteEvent(eventId) {
    if (!window.confirm(&quot;Are you sure you want to delete this event?&quot;)) return;

    // Remove locally first
    setEvents((prev) =&gt; prev.filter((event) =&gt; event.id !== eventId));
    if (editingEvent &amp;&amp; editingEvent.id === eventId) {
      setEditingEvent(null);
    }
    // NOTE: we do not call the server delete here because the &quot;save all&quot; approach
    // inserts everything to the server in bulk. If you want immediate deletes,
    // add a call to your API's delete function.
  }

  function handleCancelEdit() {
    setEditingEvent(null);
    setErrors({});
  }

  function handleSelectSlot(slotInfo) {
    try {
      const title = prompt(&quot;New event title for selected range:&quot;);
      if (!title || !title.trim()) return;

      const isAllDay = slotInfo.slots &amp;&amp; slotInfo.slots.length === 1;

      const newEventObj = {
        id: nextId(),
        title: title.trim(),
        start: slotInfo.start,
        end: slotInfo.end,
        allDay: isAllDay,
      };

      setEvents((prev) =&gt; [...prev, newEventObj]);
    } catch (error) {
      console.error(&quot;Error creating event from slot:&quot;, error);
    }
  }

  // Save all events to server (calls createEvent for each event)
  async function handleSaveAllToServer() {
    if (isSavingAll) return;
    if (!events || events.length === 0) {
      setSaveAllMessage(&quot;No events to save.&quot;);
      return;
    }

    if (!window.confirm(`Save ${events.length} event(s) to the server?`))
      return;

    setIsSavingAll(true);
    setSaveAllMessage(null);

    try {
      // fetch current authenticated user once
      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();

      if (userErr) {
        console.error(&quot;Error fetching user:&quot;, userErr);
        setSaveAllMessage(&quot;Failed to get authenticated user. Please sign in.&quot;);
        setIsSavingAll(false);
        return;
      }

      if (!user || !user.id) {
        setSaveAllMessage(&quot;You must be signed in to save events.&quot;);
        setIsSavingAll(false);
        return;
      }

      const userId = user.id;

      await Promise.all(
        events.map((ev) =&gt;
          createEvent({
            title: ev.title,
            start:
              ev.start instanceof Date
                ? ev.start.toISOString()
                : String(ev.start),
            end: ev.end instanceof Date ? ev.end.toISOString() : String(ev.end),
            allDay: !!ev.allDay,
            userId, // pass authenticated user id
            category: ev.category ?? null,
            color: ev.color ?? null,
          })
        )
      );

      setSaveAllMessage(&quot;All events were successfully saved to the server.&quot;);
    } catch (err) {
      console.error(&quot;Failed to save events:&quot;, err);
      console.error(&quot;supabase error details:&quot;, {
        message: err?.message,
        code: err?.code,
        hint: err?.hint,
        details: err?.details,
        status: err?.status,
      });
      setSaveAllMessage(&quot;Failed to save events. See console for details.&quot;);
    } finally {
      setIsSavingAll(false);
    }
  }

  return (
    &lt;div className=&quot;min-h-screen bg-black text-white p-6&quot;&gt;
      &lt;div className=&quot;max-w-7xl mx-auto&quot;&gt;
        &lt;div className=&quot;text-center mb-4&quot;&gt;
          &lt;h1 className=&quot;text-4xl font-bold text-white mb-2&quot;&gt;Calendar&lt;/h1&gt;
          &lt;p className=&quot;text-gray-400&quot;&gt;Manage your events and schedule&lt;/p&gt;
        &lt;/div&gt;

        {/* Controls: Save all button + status */}
        &lt;div className=&quot;mb-6 flex items-center justify-between gap-4&quot;&gt;
          &lt;div className=&quot;flex gap-2&quot;&gt;
            &lt;button
              onClick={handleSaveAllToServer}
              className=&quot;simple-button&quot;
              disabled={isSavingAll}
            &gt;
              {isSavingAll ? &quot;Saving...&quot; : &quot;Save all to server&quot;}
            &lt;/button&gt;
          &lt;/div&gt;

          {saveAllMessage &amp;&amp; (
            &lt;div className=&quot;text-sm text-gray-300&quot;&gt;{saveAllMessage}&lt;/div&gt;
          )}
        &lt;/div&gt;

        {/* Add event form */}
        &lt;div className=&quot;simple-card mb-8&quot;&gt;
          &lt;h2 className=&quot;text-xl font-semibold text-white mb-4&quot;&gt;
            Create New Event
          &lt;/h2&gt;

          {errors.general &amp;&amp; (
            &lt;div className=&quot;mb-4 p-3 bg-red-900/20 border border-red-500 rounded text-red-300 text-sm&quot;&gt;
              {errors.general}
            &lt;/div&gt;
          )}

          &lt;form
            onSubmit={handleAddEvent}
            className=&quot;grid grid-cols-1 md:grid-cols-4 gap-4 items-end&quot;
          &gt;
            &lt;div&gt;
              &lt;label className=&quot;block text-sm font-medium text-gray-300 mb-2&quot;&gt;
                Title *
              &lt;/label&gt;
              &lt;input
                className={`simple-input ${
                  errors.title ? &quot;border-red-500&quot; : &quot;&quot;
                }`}
                value={newEvent.title}
                onChange={(e) =&gt; {
                  setNewEvent({ ...newEvent, title: e.target.value });
                  if (errors.title) {
                    setErrors((prev) =&gt; ({ ...prev, title: null }));
                  }
                }}
                placeholder=&quot;Enter event title&quot;
                disabled={isSubmitting}
              /&gt;
              {errors.title &amp;&amp; (
                &lt;p className=&quot;text-red-400 text-xs mt-1&quot;&gt;{errors.title}&lt;/p&gt;
              )}
            &lt;/div&gt;

            &lt;div&gt;
              &lt;label className=&quot;block text-sm font-medium text-gray-300 mb-2&quot;&gt;
                Start Time *
              &lt;/label&gt;
              &lt;input
                type=&quot;datetime-local&quot;
                className={`simple-input ${
                  errors.start ? &quot;border-red-500&quot; : &quot;&quot;
                }`}
                value={newEvent.start}
                onChange={(e) =&gt; {
                  setNewEvent({ ...newEvent, start: e.target.value });
                  if (errors.start) {
                    setErrors((prev) =&gt; ({ ...prev, start: null }));
                  }
                }}
                disabled={isSubmitting}
              /&gt;
              {errors.start &amp;&amp; (
                &lt;p className=&quot;text-red-400 text-xs mt-1&quot;&gt;{errors.start}&lt;/p&gt;
              )}
            &lt;/div&gt;

            &lt;div&gt;
              &lt;label className=&quot;block text-sm font-medium text-gray-300 mb-2&quot;&gt;
                End Time *
              &lt;/label&gt;
              &lt;input
                type=&quot;datetime-local&quot;
                className={`simple-input ${errors.end ? &quot;border-red-500&quot; : &quot;&quot;}`}
                value={newEvent.end}
                onChange={(e) =&gt; {
                  setNewEvent({ ...newEvent, end: e.target.value });
                  if (errors.end) {
                    setErrors((prev) =&gt; ({ ...prev, end: null }));
                  }
                }}
                disabled={isSubmitting}
              /&gt;
              {errors.end &amp;&amp; (
                &lt;p className=&quot;text-red-400 text-xs mt-1&quot;&gt;{errors.end}&lt;/p&gt;
              )}
            &lt;/div&gt;

            &lt;div className=&quot;flex flex-col gap-4&quot;&gt;
              &lt;div className=&quot;flex items-center gap-2&quot;&gt;
                &lt;input
                  type=&quot;checkbox&quot;
                  id=&quot;allDay&quot;
                  checked={newEvent.allDay}
                  onChange={(e) =&gt;
                    setNewEvent({ ...newEvent, allDay: e.target.checked })
                  }
                  className=&quot;simple-checkbox&quot;
                  disabled={isSubmitting}
                /&gt;
                &lt;label htmlFor=&quot;allDay&quot; className=&quot;text-sm text-gray-300&quot;&gt;
                  All day event
                &lt;/label&gt;
              &lt;/div&gt;
              &lt;button
                type=&quot;submit&quot;
                className=&quot;simple-button&quot;
                disabled={isSubmitting}
              &gt;
                {isSubmitting ? &quot;Creating...&quot; : &quot;Create Event&quot;}
              &lt;/button&gt;
            &lt;/div&gt;
          &lt;/form&gt;
        &lt;/div&gt;

        {/* Calendar */}
        &lt;div className=&quot;simple-card&quot;&gt;
          &lt;h3 className=&quot;text-xl font-semibold text-white mb-4&quot;&gt;Calendar&lt;/h3&gt;
          &lt;Calendar
            localizer={localizer}
            events={events}
            startAccessor=&quot;start&quot;
            endAccessor=&quot;end&quot;
            style={{ height: 600 }}
            selectable
            onSelectEvent={handleSelectEvent}
            onSelectSlot={handleSelectSlot}
            view={currentView}
            onView={setCurrentView}
            views={[&quot;month&quot;, &quot;week&quot;, &quot;day&quot;, &quot;agenda&quot;]}
            popup
          /&gt;
        &lt;/div&gt;

        {editingEvent &amp;&amp; (
          &lt;div className=&quot;simple-card&quot;&gt;
            &lt;h3 className=&quot;text-xl font-semibold mb-4 text-white&quot;&gt;
              Edit Event
            &lt;/h3&gt;

            &lt;form onSubmit={handleUpdateEvent}&gt;
              &lt;div className=&quot;space-y-4&quot;&gt;
                &lt;div&gt;
                  &lt;label
                    htmlFor=&quot;edit-title&quot;
                    className=&quot;block text-sm font-medium text-gray-300 mb-1&quot;
                  &gt;
                    Event Title
                  &lt;/label&gt;
                  &lt;input
                    type=&quot;text&quot;
                    id=&quot;edit-title&quot;
                    className=&quot;simple-input&quot;
                    placeholder=&quot;Enter event title...&quot;
                    value={editingEvent.title}
                    onChange={(e) =&gt;
                      setEditingEvent((prev) =&gt; ({
                        ...prev,
                        title: e.target.value,
                      }))
                    }
                  /&gt;
                  {errors.title &amp;&amp; (
                    &lt;p className=&quot;text-red-400 text-sm mt-1&quot;&gt;{errors.title}&lt;/p&gt;
                  )}
                &lt;/div&gt;

                &lt;div&gt;
                  &lt;label
                    htmlFor=&quot;edit-start&quot;
                    className=&quot;block text-sm font-medium text-gray-300 mb-1&quot;
                  &gt;
                    Start Date &amp; Time
                  &lt;/label&gt;
                  &lt;input
                    type=&quot;datetime-local&quot;
                    id=&quot;edit-start&quot;
                    className=&quot;simple-input&quot;
                    value={editingEvent.start}
                    onChange={(e) =&gt;
                      setEditingEvent((prev) =&gt; ({
                        ...prev,
                        start: e.target.value,
                      }))
                    }
                  /&gt;
                  {errors.start &amp;&amp; (
                    &lt;p className=&quot;text-red-400 text-sm mt-1&quot;&gt;{errors.start}&lt;/p&gt;
                  )}
                &lt;/div&gt;

                &lt;div&gt;
                  &lt;label
                    htmlFor=&quot;edit-end&quot;
                    className=&quot;block text-sm font-medium text-gray-300 mb-1&quot;
                  &gt;
                    End Date &amp; Time
                  &lt;/label&gt;
                  &lt;input
                    type=&quot;datetime-local&quot;
                    id=&quot;edit-end&quot;
                    className=&quot;simple-input&quot;
                    value={editingEvent.end}
                    onChange={(e) =&gt;
                      setEditingEvent((prev) =&gt; ({
                        ...prev,
                        end: e.target.value,
                      }))
                    }
                  /&gt;
                  {errors.end &amp;&amp; (
                    &lt;p className=&quot;text-red-400 text-sm mt-1&quot;&gt;{errors.end}&lt;/p&gt;
                  )}
                &lt;/div&gt;

                {errors.general &amp;&amp; (
                  &lt;div className=&quot;text-red-400 text-sm&quot;&gt;{errors.general}&lt;/div&gt;
                )}

                &lt;div className=&quot;flex gap-2&quot;&gt;
                  &lt;button
                    type=&quot;submit&quot;
                    disabled={isSubmitting}
                    className=&quot;simple-button flex-1&quot;
                  &gt;
                    {isSubmitting ? &quot;Updating...&quot; : &quot;Update Event&quot;}
                  &lt;/button&gt;

                  &lt;button
                    type=&quot;button&quot;
                    onClick={() =&gt; handleDeleteEvent(editingEvent.id)}
                    className=&quot;simple-button bg-red-600 hover:bg-red-700 flex-1&quot;
                  &gt;
                    Delete Event
                  &lt;/button&gt;

                  &lt;button
                    type=&quot;button&quot;
                    onClick={handleCancelEdit}
                    className=&quot;simple-button bg-gray-600 hover:bg-gray-700 flex-1&quot;
                  &gt;
                    Cancel
                  &lt;/button&gt;
                &lt;/div&gt;
              &lt;/div&gt;
            &lt;/form&gt;
          &lt;/div&gt;
        )}
      &lt;/div&gt;
    &lt;/div&gt;
  );
}
</div>
<script src="https://www.zeljkoobrenovic.com/tools/common/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/html");
    editor.setTheme("ace/theme/xcode");
    editor.setReadOnly(true);
    editor.setOption("wrap", true);
    editor.setPrintMarginColumn(120);
</script>
</body>
